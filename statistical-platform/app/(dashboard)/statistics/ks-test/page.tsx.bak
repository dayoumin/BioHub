'use client'

import React, { useState, useCallback } from 'react'
import type { KSTestVariables } from '@/types/statistics'
import { toKSTestVariables, type VariableAssignment } from '@/types/statistics-converters'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Separator } from '@/components/ui/separator'
import {
  Activity,
  Upload,
  Users,
  TrendingUp,
  AlertCircle,
  CheckCircle,
  FileText,
  Download,
  Info,
  BarChart3
} from 'lucide-react'

import { StatisticsPageLayout, StepCard, StatisticsStep } from '@/components/statistics/StatisticsPageLayout'
import { DataUploadStep } from '@/components/smart-flow/steps/DataUploadStep'
import { VariableSelector } from '@/components/variable-selection/VariableSelector'
import { useStatisticsPage } from '@/hooks/use-statistics-page'
import type { PyodideInterface } from '@/types/pyodide'
import { loadPyodideWithPackages } from '@/lib/utils/pyodide-loader'

// 데이터 인터페이스
// 로컬 인터페이스 제거: types/statistics.ts의 KSTestVariables 사용
// interface VariableSelection {
//   variables: string[]
// }

// K-S 검정 타입 정의
interface KSTestResult {
  testType: 'one-sample' | 'two-sample'
  variable1: string
  variable2?: string
  statisticKS: number
  pValue: number
  criticalValue?: number
  significant: boolean
  interpretation: string
  effectSize?: number
  sampleSizes: {
    n1: number
    n2?: number
  }
  distributionInfo?: {
    expectedDistribution: string
    observedMean: number
    observedStd: number
    expectedMean?: number
    expectedStd?: number
  }
}

export default function KolmogorovSmirnovTestPage() {
  // Hook for state management
  const { state, actions } = useStatisticsPage<KSTestResult, KSTestVariables>({
    withUploadedData: true,
    withError: true
  })
  const { currentStep, uploadedData, selectedVariables, isAnalyzing, results, error } = state

  // K-S 검정 단계 정의
  const steps: StatisticsStep[] = [
    {
      id: 'method',
      number: 1,
      title: 'K-S 검정 소개',
      description: '분포 동일성 검정 개념',
      status: currentStep === 0 ? 'current' : currentStep > 0 ? 'completed' : 'pending'
    },
    {
      id: 'upload',
      number: 2,
      title: '데이터 업로드',
      description: '분석할 데이터 파일 업로드',
      status: currentStep === 1 ? 'current' : currentStep > 1 ? 'completed' : 'pending'
    },
    {
      id: 'variables',
      number: 3,
      title: '변수 선택',
      description: '비교할 변수 선택',
      status: currentStep === 2 ? 'current' : currentStep > 2 ? 'completed' : 'pending'
    },
    {
      id: 'results',
      number: 4,
      title: '결과 해석',
      description: 'K-S 검정 결과 확인',
      status: currentStep === 3 ? 'current' : 'pending'
    }
  ]

  const handleDataUpload = useCallback((data: UploadedData) => {
    actions.setUploadedData?.(data)
    actions.setCurrentStep?.(2)
  }, [actions])

  // 일표본 K-S 검정 (정규분포 가정) - scipy 사용
  const calculateOneSampleKS = useCallback(async (
    values: number[],
    variable: string,
    pyodide: PyodideInterface
  ): Promise<KSTestResult> => {
    const n = values.length

    // Python에 데이터 전달
    pyodide.globals.set('js_values', values)

    // scipy를 사용한 K-S 검정
    const result = await pyodide.runPythonAsync(`
from scipy import stats
import numpy as np

values = np.array(js_values)
n = len(values)
mean = float(np.mean(values))
std = float(np.std(values, ddof=1))

# K-S 검정 (정규분포 가정)
statistic, pvalue = stats.kstest(values, 'norm', args=(mean, std))

# 임계값 계산 (α = 0.05)
critical_value = 1.36 / np.sqrt(n)

{
  'testType': 'one-sample',
  'variable1': '${variable}',
  'statisticKS': float(statistic),
  'pValue': float(pvalue),
  'criticalValue': float(critical_value),
  'significant': bool(statistic > critical_value),
  'interpretation': 'データが正規分布に従わない' if statistic > critical_value else 'データが正規分布に従う',
  'sampleSizes': {
    'n1': int(n)
  },
  'distributionInfo': {
    'expectedDistribution': '정규분포',
    'observedMean': float(mean),
    'observedStd': float(std),
    'expectedMean': float(mean),
    'expectedStd': float(std)
  }
}
    `)

    const jsResult = result.toJs({ dict_converter: Object.fromEntries })

    return {
      testType: jsResult.testType as 'one-sample',
      variable1: jsResult.variable1 as string,
      statisticKS: jsResult.statisticKS as number,
      pValue: jsResult.pValue as number,
      criticalValue: jsResult.criticalValue as number,
      significant: jsResult.significant as boolean,
      interpretation: jsResult.significant
        ? '데이터가 정규분포를 따르지 않는 것으로 보임'
        : '데이터가 정규분포를 따르는 것으로 보임',
      sampleSizes: {
        n1: jsResult.sampleSizes.n1 as number
      },
      distributionInfo: {
        expectedDistribution: jsResult.distributionInfo.expectedDistribution as string,
        observedMean: jsResult.distributionInfo.observedMean as number,
        observedStd: jsResult.distributionInfo.observedStd as number,
        expectedMean: jsResult.distributionInfo.expectedMean as number,
        expectedStd: jsResult.distributionInfo.expectedStd as number
      }
    }
  }, [])

  // 이표본 K-S 검정 - scipy 사용
  const calculateTwoSampleKS = useCallback(async (
    values1: number[],
    values2: number[],
    variable1: string,
    variable2: string,
    pyodide: PyodideInterface
  ): Promise<KSTestResult> => {
    const n1 = values1.length
    const n2 = values2.length

    // Python에 데이터 전달
    pyodide.globals.set('js_values1', values1)
    pyodide.globals.set('js_values2', values2)

    // scipy를 사용한 이표본 K-S 검정
    const result = await pyodide.runPythonAsync(`
from scipy import stats
import numpy as np
import { type UploadedData } from '@/hooks/use-statistics-page'

values1 = np.array(js_values1)
values2 = np.array(js_values2)
n1 = len(values1)
n2 = len(values2)

# 이표본 K-S 검정
statistic, pvalue = stats.ks_2samp(values1, values2)

# 임계값 계산 (α = 0.05)
critical_value = 1.36 * np.sqrt((n1 + n2) / (n1 * n2))

# 효과크기 (Cohen's d)
mean1 = float(np.mean(values1))
mean2 = float(np.mean(values2))
pooled_std = float(np.sqrt(((n1 - 1) * np.var(values1, ddof=1) + (n2 - 1) * np.var(values2, ddof=1)) / (n1 + n2 - 2)))
effect_size = abs(mean1 - mean2) / pooled_std if pooled_std > 0 else 0.0

{
  'testType': 'two-sample',
  'variable1': '${variable1}',
  'variable2': '${variable2}',
  'statisticKS': float(statistic),
  'pValue': float(pvalue),
  'criticalValue': float(critical_value),
  'significant': bool(statistic > critical_value),
  'interpretation': '두 집단의 분포가 유의하게 다름' if statistic > critical_value else '두 집단의 분포가 유의하게 다르지 않음',
  'effectSize': float(effect_size),
  'sampleSizes': {
    'n1': int(n1),
    'n2': int(n2)
  }
}
    `)

    const jsResult = result.toJs({ dict_converter: Object.fromEntries })

    return {
      testType: jsResult.testType as 'two-sample',
      variable1: jsResult.variable1 as string,
      variable2: jsResult.variable2 as string,
      statisticKS: jsResult.statisticKS as number,
      pValue: jsResult.pValue as number,
      criticalValue: jsResult.criticalValue as number,
      significant: jsResult.significant as boolean,
      interpretation: jsResult.significant
        ? '두 집단의 분포가 유의하게 다름'
        : '두 집단의 분포가 유의하게 다르지 않음',
      effectSize: jsResult.effectSize as number,
      sampleSizes: {
        n1: jsResult.sampleSizes.n1 as number,
        n2: jsResult.sampleSizes.n2 as number
      }
    }
  }, [])

  // 실제 K-S 검정 계산 로직 - Pyodide 사용
  const calculateKSTest = useCallback(async (
    data: unknown[],
    variable1: string,
    variable2: string | undefined,
    pyodide: PyodideInterface
  ): Promise<KSTestResult> => {
    const values1 = data.map(row => (row as Record<string, unknown>)[variable1])
      .filter(val => val != null && typeof val === 'number') as number[]

    if (variable2) {
      // 이표본 K-S 검정
      const values2 = data.map(row => (row as Record<string, unknown>)[variable2])
        .filter(val => val != null && typeof val === 'number') as number[]

      return await calculateTwoSampleKS(values1, values2, variable1, variable2, pyodide)
    } else {
      // 일표본 K-S 검정 (정규분포와 비교)
      return await calculateOneSampleKS(values1, variable1, pyodide)
    }
  }, [calculateOneSampleKS, calculateTwoSampleKS])

  const runAnalysis = useCallback(async (variables: KSTestVariables) => {
    if (!uploadedData) return

    try {
      actions.startAnalysis()

      // Pyodide 로딩 (scipy 패키지 포함)
      const pyodide: PyodideInterface = await loadPyodideWithPackages(['numpy', 'scipy'])

      const variable2 = variables.variables.length > 1 ? variables.variables[1] : undefined
      const result = await calculateKSTest(uploadedData.data, variables.variables[0], variable2, pyodide)

      actions.completeAnalysis(result, 3)
    } catch (error) {
      console.error('K-S 검정 분석 중 오류:', error)
      const errorMessage = error instanceof Error ? error.message : '분석 중 오류가 발생했습니다.'
      actions.setError(errorMessage)
    }
  }, [uploadedData, calculateKSTest, actions])

  const handleVariableSelection = useCallback((variables: KSTestVariables) => {
    actions.setSelectedVariables?.(variables)
    runAnalysis(variables)
  }, [runAnalysis, actions])

  const renderMethodIntroduction = () => (
    <StepCard
      title="Kolmogorov-Smirnov 검정"
      description="분포의 동일성을 검정하는 비모수 통계 테스트"
      icon={<Info className="w-5 h-5 text-blue-500" />}
    >
      <div className="space-y-6">
        <div className="grid md:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <Activity className="w-5 h-5" />
                K-S 검정이란?
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <p className="text-sm text-muted-foreground">
                두 분포의 <strong>누적분포함수(CDF)</strong> 간의 최대 차이를 이용하여
                분포의 동일성을 검정하는 비모수 방법입니다.
              </p>
              <div className="bg-muted p-3 rounded-lg">
                <p className="text-xs font-medium mb-1">검정 통계량</p>
                <p className="text-xs text-muted-foreground">
                  D = max|F₁(x) - F₂(x)|<br/>
                  F₁, F₂: 각각의 경험적 분포함수
                </p>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <BarChart3 className="w-5 h-5" />
                사용 사례
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-500" />
                  <span className="text-sm">정규성 검정 (일표본)</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-500" />
                  <span className="text-sm">두 집단 분포 비교 (이표본)</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-500" />
                  <span className="text-sm">모델 적합도 검정</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-500" />
                  <span className="text-sm">분포 가정 확인</span>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        <Alert>
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>가정 및 조건</AlertTitle>
          <AlertDescription>
            <ul className="mt-2 space-y-1 text-sm">
              <li>• 연속형 변수 (이산형도 가능하나 정확도 떨어짐)</li>
              <li>• 관측값들이 독립적이어야 함</li>
              <li>• 분포에 대한 가정이 필요하지 않음 (비모수)</li>
              <li>• 표본 크기가 클수록 검정력 증가</li>
            </ul>
          </AlertDescription>
        </Alert>

        <div className="text-center">
          <Button
            onClick={() => actions.setCurrentStep(1)}
            className="w-full md:w-auto"
          >
            데이터 업로드하기
          </Button>
        </div>
      </div>
    </StepCard>
  )

  const renderDataUpload = () => (
    <StepCard
      title="데이터 업로드"
      description="K-S 검정을 수행할 데이터를 업로드하세요"
      icon={<Upload className="w-5 h-5 text-primary" />}
    >
      <DataUploadStep
        onUploadComplete={(file: File, data: Record<string, unknown>[]) => {
          const columns = Object.keys(data[0] || {})
          handleDataUpload({
            data,
            fileName: file.name,
            columns
          })
        }}
      />
    </StepCard>
  )

  const renderVariableSelection = () => {
    if (!uploadedData) return null

    return (
      <StepCard
        title="변수 선택"
        description="분포를 비교할 변수를 선택하세요"
        icon={<Users className="w-5 h-5 text-primary" />}
      >
        <Alert className="mb-4">
          <Info className="h-4 w-4" />
          <AlertTitle>검정 유형</AlertTitle>
          <AlertDescription>
            <div className="mt-2 space-y-1 text-sm">
              <p>• <strong>1개 변수 선택</strong>: 일표본 K-S 검정 (정규분포 가정 검정)</p>
              <p>• <strong>2개 변수 선택</strong>: 이표본 K-S 검정 (두 집단 분포 비교)</p>
            </div>
          </AlertDescription>
        </Alert>
        <VariableSelector
          methodId="kolmogorovSmirnov"
          data={uploadedData.data}
          onVariablesSelected={(variables) => {
            // Convert VariableAssignment to VariableSelection
            const variableArray = Object.values(variables).flat().filter(v => typeof v === 'string') as string[]
            handleVariableSelection({ variables: variableArray })
          }}
        />
      </StepCard>
    )
  }

  const renderResults = () => {
    if (!results) return null

    const {
      testType,
      variable1,
      variable2,
      statisticKS,
      pValue,
      criticalValue,
      significant,
      interpretation,
      effectSize,
      sampleSizes,
      distributionInfo
    } = results

    return (
      <StepCard
        title="K-S 검정 결과"
        description={`${testType === 'one-sample' ? '일표본' : '이표본'} 분포 검정 결과`}
        icon={<TrendingUp className="w-5 h-5 text-primary" />}
      >
        <div className="space-y-6">
          {/* 주요 결과 요약 */}
          <Alert className={significant ? "border-red-500 bg-muted" : "border-green-500 bg-muted"}>
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>검정 결과</AlertTitle>
            <AlertDescription>
              <div className="mt-2 space-y-2">
                <p className="font-medium">
                  D = {statisticKS.toFixed(4)}, p = {pValue.toFixed(3)}
                </p>
                <p>
                  {significant
                    ? "❌ 분포가 유의하게 다릅니다 (p < 0.05)"
                    : "✅ 분포가 유의하게 다르지 않습니다 (p ≥ 0.05)"}
                </p>
                <p className="text-sm text-muted-foreground">{interpretation}</p>
              </div>
            </AlertDescription>
          </Alert>

          {/* 검정 통계량 */}
          <div className="grid md:grid-cols-2 gap-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-base">검정 통계량</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="text-center p-3 bg-primary/10 rounded-lg">
                  <p className="font-medium">K-S 통계량 (D)</p>
                  <p className="text-2xl font-bold text-primary">{statisticKS.toFixed(4)}</p>
                </div>
                <Separator />
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span>p-value</span>
                    <Badge variant={significant ? "destructive" : "default"}>
                      {pValue < 0.001 ? '< 0.001' : pValue.toFixed(3)}
                    </Badge>
                  </div>
                  {criticalValue && (
                    <div className="flex justify-between">
                      <span>임계값 (α = 0.05)</span>
                      <Badge variant="outline">{criticalValue.toFixed(4)}</Badge>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-base">표본 정보</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span>{variable1} 표본수</span>
                    <Badge>{sampleSizes.n1}</Badge>
                  </div>
                  {sampleSizes.n2 && variable2 && (
                    <div className="flex justify-between">
                      <span>{variable2} 표본수</span>
                      <Badge>{sampleSizes.n2}</Badge>
                    </div>
                  )}
                  {effectSize && (
                    <div className="flex justify-between">
                      <span>효과크기</span>
                      <Badge variant={effectSize > 0.8 ? "default" : effectSize > 0.5 ? "secondary" : "outline"}>
                        {effectSize.toFixed(3)}
                      </Badge>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* 분포 정보 (일표본인 경우) */}
          {distributionInfo && testType === 'one-sample' && (
            <Card>
              <CardHeader>
                <CardTitle className="text-base">분포 적합도 정보</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div className="text-center p-3 bg-muted rounded-lg">
                    <p className="font-medium">관측 평균</p>
                    <p className="text-lg font-bold text-muted-foreground">{distributionInfo.observedMean.toFixed(3)}</p>
                  </div>
                  <div className="text-center p-3 bg-gray-50 rounded-lg">
                    <p className="font-medium">관측 표준편차</p>
                    <p className="text-lg font-bold text-gray-600">{distributionInfo.observedStd.toFixed(3)}</p>
                  </div>
                </div>
                <Alert>
                  <Info className="h-4 w-4" />
                  <AlertTitle>분포 비교</AlertTitle>
                  <AlertDescription>
                    <p className="text-sm mt-2">
                      관측된 데이터와 {distributionInfo.expectedDistribution} 간의 최대 차이를 측정합니다.
                      D 값이 클수록 분포의 차이가 큼을 의미합니다.
                    </p>
                  </AlertDescription>
                </Alert>
              </CardContent>
            </Card>
          )}

          {/* 해석 가이드 */}
          <Card>
            <CardHeader>
              <CardTitle className="text-base">결과 해석 가이드</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <Alert>
                <Info className="h-4 w-4" />
                <AlertTitle>K-S 검정 해석</AlertTitle>
                <AlertDescription>
                  <div className="mt-2 space-y-2 text-sm">
                    <p><strong>귀무가설(H₀):</strong> 두 분포가 동일하다</p>
                    <p><strong>대립가설(H₁):</strong> 두 분포가 다르다</p>
                    <p><strong>판단기준:</strong> p-value &lt; 0.05이면 귀무가설 기각</p>
                  </div>
                </AlertDescription>
              </Alert>

              {testType === 'two-sample' && effectSize && (
                <div className="bg-muted p-4 rounded-lg">
                  <h4 className="font-medium mb-2">효과크기 해석</h4>
                  <div className="text-sm text-muted-foreground space-y-1">
                    <p>• <strong>작은 효과</strong>: 0.2 ~ 0.5</p>
                    <p>• <strong>중간 효과</strong>: 0.5 ~ 0.8</p>
                    <p>• <strong>큰 효과</strong>: 0.8 이상</p>
                    <p className="mt-2 font-medium">현재 효과크기: {effectSize.toFixed(3)}
                      ({effectSize < 0.5 ? '작음' : effectSize < 0.8 ? '중간' : '큼'})
                    </p>
                  </div>
                </div>
              )}

              <div className="bg-muted p-4 rounded-lg">
                <h4 className="font-medium mb-2">주의사항</h4>
                <ul className="text-sm text-muted-foreground space-y-1">
                  <li>• K-S 검정은 분포의 모든 측면(위치, 척도, 모양)을 고려합니다</li>
                  <li>• 표본 크기가 클수록 작은 차이도 유의하게 검출될 수 있습니다</li>
                  <li>• 이산형 데이터에서는 보수적인 결과를 보일 수 있습니다</li>
                </ul>
              </div>
            </CardContent>
          </Card>

          {/* 액션 버튼 */}
          <div className="flex gap-3 justify-center pt-4">
            <Button variant="outline" onClick={() => {}}>
              <FileText className="w-4 h-4 mr-2" />
              보고서 생성
            </Button>
            <Button variant="outline" onClick={() => {}}>
              <Download className="w-4 h-4 mr-2" />
              결과 다운로드
            </Button>
          </div>
        </div>
      </StepCard>
    )
  }

  return (
    <StatisticsPageLayout
      title="Kolmogorov-Smirnov 검정"
      subtitle="K-S Test - 분포의 동일성 검정"
      icon={<Activity className="w-6 h-6" />}
      methodInfo={{
        formula: 'D = max|F₁(x) - F₂(x)|, 임계값 = 1.36/√n (일표본)',
        assumptions: ['연속형 변수', '독립성', '비모수적'],
        sampleSize: '제한 없음 (클수록 검정력 증가)',
        usage: '정규성 검정, 분포 비교, 적합도 검정'
      }}
      steps={steps}
      currentStep={currentStep}
      onStepChange={actions.setCurrentStep}
      onRun={() => selectedVariables && runAnalysis(selectedVariables)}
      onReset={actions.reset}
      isRunning={isAnalyzing}
      showProgress={true}
      showTips={true}
    >
      {currentStep === 0 && renderMethodIntroduction()}
      {currentStep === 1 && renderDataUpload()}
      {currentStep === 2 && renderVariableSelection()}
      {currentStep === 3 && renderResults()}
    </StatisticsPageLayout>
  )
}