<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vector Store ì´ˆê¸°í™”</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .info {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #c82333;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .error {
      color: #dc3545;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ Vector Store ì´ˆê¸°í™”</h1>

    <div class="warning">
      <strong>âš ï¸ ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ëª¨ë“  RAG ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
      <ul>
        <li>IndexedDBì˜ ëª¨ë“  ë²¡í„° ì„ë² ë”© ì‚­ì œ</li>
        <li>SQLite ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ</li>
        <li>RAG ì„¤ì • ì´ˆê¸°í™”</li>
      </ul>
      ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
    </div>

    <div class="info">
      <strong>â„¹ï¸ ì„ë² ë”© ëª¨ë¸ ë³€ê²½ ì‹œ í•„ìˆ˜:</strong><br>
      ì„ë² ë”© ëª¨ë¸ì„ ë³€ê²½í•œ ê²½ìš° (ì˜ˆ: qwen3-embedding ì—…ë°ì´íŠ¸), ê¸°ì¡´ ë²¡í„° ë°ì´í„°ì™€ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤.
    </div>

    <div>
      <button onclick="resetVectorStore()" id="resetBtn">ğŸ—‘ï¸ Vector Store ì´ˆê¸°í™”</button>
      <button onclick="checkStatus()" class="secondary">ğŸ“Š í˜„ì¬ ìƒíƒœ í™•ì¸</button>
      <button onclick="clearLog()" class="secondary">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div id="log" class="log"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('ko-KR');
      const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${prefix} ${message}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function checkStatus() {
      log('í˜„ì¬ Vector Store ìƒíƒœ í™•ì¸ ì¤‘...');

      try {
        // IndexedDB í™•ì¸
        const databases = await window.indexedDB.databases();
        const ragDatabases = databases.filter(db =>
          db.name === 'rag-storage' || db.name === 'sqljs-persistent-storage'
        );

        if (ragDatabases.length > 0) {
          log(`IndexedDB ë°œê²¬: ${ragDatabases.map(db => db.name).join(', ')}`);
        } else {
          log('IndexedDB: ë°ì´í„° ì—†ìŒ', 'success');
        }

        // localStorage í™•ì¸
        const embeddingModel = localStorage.getItem('statPlatform_embeddingModel');
        const inferenceModel = localStorage.getItem('statPlatform_inferenceModel');
        const ollamaEndpoint = localStorage.getItem('statPlatform_ollamaEndpoint');

        if (embeddingModel || inferenceModel || ollamaEndpoint) {
          log(`localStorage ì„¤ì • ë°œê²¬:`);
          if (embeddingModel) log(`  - ì„ë² ë”© ëª¨ë¸: ${embeddingModel}`);
          if (inferenceModel) log(`  - ì¶”ë¡  ëª¨ë¸: ${inferenceModel}`);
          if (ollamaEndpoint) log(`  - Ollama ì—”ë“œí¬ì¸íŠ¸: ${ollamaEndpoint}`);
        } else {
          log('localStorage: ì„¤ì • ì—†ìŒ', 'success');
        }

        log('ìƒíƒœ í™•ì¸ ì™„ë£Œ!', 'success');
      } catch (error) {
        log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      }
    }

    async function resetVectorStore() {
      const confirmed = confirm(
        'ì •ë§ë¡œ Vector Storeë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
        'ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'
      );

      if (!confirmed) {
        log('ì‘ì—… ì·¨ì†Œë¨');
        return;
      }

      const resetBtn = document.getElementById('resetBtn');
      resetBtn.disabled = true;
      resetBtn.textContent = 'â³ ì´ˆê¸°í™” ì¤‘...';

      try {
        log('Vector Store ì´ˆê¸°í™” ì‹œì‘...');

        // 1. IndexedDB ì‚­ì œ
        log('1/3: IndexedDB ì‚­ì œ ì¤‘...');

        await new Promise((resolve, reject) => {
          const deleteRequest1 = window.indexedDB.deleteDatabase('rag-storage');
          deleteRequest1.onsuccess = () => {
            log('  âœ“ rag-storage ì‚­ì œ ì™„ë£Œ', 'success');
            resolve();
          };
          deleteRequest1.onerror = () => reject(deleteRequest1.error);
          deleteRequest1.onblocked = () => {
            log('  âš ï¸ rag-storage ì‚­ì œ ì°¨ë‹¨ë¨ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ)');
            resolve(); // ê³„ì† ì§„í–‰
          };
        });

        await new Promise((resolve, reject) => {
          const deleteRequest2 = window.indexedDB.deleteDatabase('sqljs-persistent-storage');
          deleteRequest2.onsuccess = () => {
            log('  âœ“ sqljs-persistent-storage ì‚­ì œ ì™„ë£Œ', 'success');
            resolve();
          };
          deleteRequest2.onerror = () => reject(deleteRequest2.error);
          deleteRequest2.onblocked = () => {
            log('  âš ï¸ sqljs-persistent-storage ì‚­ì œ ì°¨ë‹¨ë¨ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ)');
            resolve(); // ê³„ì† ì§„í–‰
          };
        });

        // 2. localStorage ì´ˆê¸°í™”
        log('2/3: localStorage ì´ˆê¸°í™” ì¤‘...');
        localStorage.removeItem('statPlatform_embeddingModel');
        localStorage.removeItem('statPlatform_inferenceModel');
        localStorage.removeItem('statPlatform_ollamaEndpoint');
        localStorage.removeItem('statPlatform_topK');
        log('  âœ“ localStorage ì´ˆê¸°í™” ì™„ë£Œ', 'success');

        // 3. ì™„ë£Œ
        log('3/3: ì´ˆê¸°í™” ì™„ë£Œ!', 'success');
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        log('âœ… Vector Storeê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        log('');
        log('ë‹¤ìŒ ë‹¨ê³„:');
        log('1. ì´ í˜ì´ì§€ë¥¼ ë‹«ìœ¼ì„¸ìš”');
        log('2. ì• í”Œë¦¬ì¼€ì´ì…˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš” (F5)');
        log('3. ìƒˆë¡œìš´ ì„ë² ë”© ëª¨ë¸ë¡œ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì¸ë±ì‹±í•˜ì„¸ìš”');

        // 5ì´ˆ í›„ ë²„íŠ¼ í™œì„±í™”
        setTimeout(() => {
          resetBtn.disabled = false;
          resetBtn.textContent = 'ğŸ—‘ï¸ Vector Store ì´ˆê¸°í™”';
        }, 5000);

      } catch (error) {
        log(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
        resetBtn.disabled = false;
        resetBtn.textContent = 'ğŸ—‘ï¸ Vector Store ì´ˆê¸°í™”';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
    window.addEventListener('DOMContentLoaded', () => {
      log('Vector Store ì´ˆê¸°í™” ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ');
      log('í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ë ¤ë©´ "í˜„ì¬ ìƒíƒœ í™•ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
    });
  </script>
</body>
</html>