# RAG ê°œì„ ì•ˆ ì„±ëŠ¥ ë¶„ì„ (Performance-First)

**ì‘ì„±ì¼**: 2025-11-15
**í•µì‹¬**: ì„±ëŠ¥ vs ì •í™•ë„ íŠ¸ë ˆì´ë“œì˜¤í”„ ë¶„ì„

---

## âš¡ ì„±ëŠ¥ ì˜í–¥ ë¶„ì„

### í˜„ì¬ ì‹œìŠ¤í…œ ì„±ëŠ¥ (Baseline)

```
ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥
  â†“
Vector ê²€ìƒ‰ (Cosine Similarity)     ~50-100ms
  â†“
Top-5 ë¬¸ì„œ ì¶”ì¶œ                     ~10ms
  â†“
LLM ì»¨í…ìŠ¤íŠ¸ ìƒì„±                   ~20ms
  â†“
Ollama ì¶”ë¡  (Streaming)             ~2-5ì´ˆ (ëª¨ë¸ í¬ê¸° ì˜ì¡´)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ ì‘ë‹µ ì‹œê°„: ~2.2-5.2ì´ˆ (ì–‘í˜¸)
```

---

## ğŸ“Š ê° ê°œì„ ì•ˆì˜ ì„±ëŠ¥ ì˜í–¥

### âŒ **ê³¼ë„í•œ ê°œì„ ì•ˆ (ì„±ëŠ¥ ì €í•˜ ì‹¬ê°)**

#### 1. **ì‹œë§¨í‹± ì²­í‚¹ (Semantic Chunking)** - âš ï¸ ê³¼ë„í•¨
**ë¬¸ì œì **:
- **ë¬¸ì„œ ì¶”ê°€ ì‹œ**: ëª¨ë“  ë¬¸ì¥ ì„ë² ë”© ê³„ì‚° í•„ìš”
- **ê³„ì‚°ëŸ‰**: O(nÂ²) - ë¬¸ì¥ ê°„ ìœ ì‚¬ë„ ë¹„êµ
- **ì²˜ë¦¬ ì‹œê°„**:
  - 1,000 ë¬¸ì¥ ë¬¸ì„œ â†’ 1,000ê°œ ì„ë² ë”© ìƒì„± â†’ ~30-60ì´ˆ
  - 100ê°œ ë¬¸ì„œ â†’ 5-10ë¶„ (ì¬ì¸ë±ì‹± ì‹œ)

**ì„±ëŠ¥ ì˜í–¥**:
```
Before: ë¬¸ì„œ 1ê°œ ì¶”ê°€ â†’ ~2ì´ˆ (ê¸°ì¡´ ì²­í‚¹)
After:  ë¬¸ì„œ 1ê°œ ì¶”ê°€ â†’ ~30-60ì´ˆ (+1,400% ì¦ê°€)
```

**ê²°ë¡ **: âŒ **ë°°ì¹˜ ì¸ë±ì‹± ì „ìš©, ì‹¤ì‹œê°„ì—ëŠ” ë¶€ì í•©**

---

#### 2. **Hybrid Search (BM25 + Vector)** - âš ï¸ ì¤‘ê°„
**ë¬¸ì œì **:
- BM25 ì¸ë±ìŠ¤ ë©”ëª¨ë¦¬ ì‚¬ìš© ì¦ê°€ (~50MB for 1,000 docs)
- ê²€ìƒ‰ ì‹œ 2ë²ˆ ì‹¤í–‰ (BM25 + Vector)
- RRF ê³„ì‚° ì˜¤ë²„í—¤ë“œ

**ì„±ëŠ¥ ì˜í–¥**:
```
Before: Vector ê²€ìƒ‰ â†’ ~50-100ms
After:  Vector + BM25 + RRF â†’ ~150-200ms (+50-100ms)
```

**ê²°ë¡ **: âš ï¸ **í—ˆìš© ê°€ëŠ¥, í•˜ì§€ë§Œ íš¨ê³¼ ëŒ€ë¹„ ë¯¸ë¯¸**

---

#### 3. **LLM Query Rewriting (10ê°œ ë³€í˜•)** - âŒ ê³¼ë„í•¨
**ë¬¸ì œì **:
- 10ê°œ ë³€í˜• ìƒì„± â†’ LLM í˜¸ì¶œ 1íšŒ (~500ms-1ì´ˆ)
- 10ê°œ ì¿¼ë¦¬ë¡œ Vector ê²€ìƒ‰ â†’ 10ë°° ê³„ì‚°ëŸ‰
- ê²°ê³¼ ë³‘í•© ì˜¤ë²„í—¤ë“œ

**ì„±ëŠ¥ ì˜í–¥**:
```
Before: ì§ˆë¬¸ â†’ Vector ê²€ìƒ‰ â†’ ~100ms
After:  ì§ˆë¬¸ â†’ LLM Rewrite (~1ì´ˆ) â†’ Vector ê²€ìƒ‰ x10 (~1ì´ˆ) â†’ ~2ì´ˆ
```

**ê²°ë¡ **: âŒ **ì‘ë‹µ ì‹œê°„ 2ì´ˆ ì¶”ê°€, ì‚¬ìš©ì ê²½í—˜ ì €í•˜**

---

### âœ… **íš¨ìœ¨ì ì¸ ê°œì„ ì•ˆ (ì„±ëŠ¥ ìš°ì„ )**

#### 1. **Ollama Reranking (Top-20 â†’ Top-5)** - âœ… ì¶”ì²œ
**ì„±ëŠ¥ ì˜í–¥**:
```
Vector ê²€ìƒ‰ (Top-20)                ~100ms (ê¸°ì¡´ 50ms + 50ms)
  â†“
LLM Reranking (20ê°œ ë¬¸ì„œ)           ~200-500ms (Ollama)
  â†“
Top-5 ì„ íƒ                          ~10ms
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì¶”ê°€ ì‹œê°„: +300-600ms
ì´ ì‘ë‹µ ì‹œê°„: 2.5-5.8ì´ˆ (ê¸°ì¡´ 2.2-5.2ì´ˆ)
```

**íš¨ê³¼**:
- ì •í™•ë„ +50-100%
- ì‘ë‹µ ì‹œê°„ +10-15% (í—ˆìš© ê°€ëŠ¥)

**ê²°ë¡ **: âœ… **ìµœê³ ì˜ ê°€ì„±ë¹„**

---

#### 2. **ì •ì  ë™ì˜ì–´ ì‚¬ì „ (Query Expansion)** - âœ… ì¶”ì²œ
**ì„±ëŠ¥ ì˜í–¥**:
```
ë™ì˜ì–´ ê²€ìƒ‰ (ë©”ëª¨ë¦¬ ë‚´ HashMap)    ~1-2ms
ë³€í˜• ì¿¼ë¦¬ 3-5ê°œ ìƒì„±                ~5ms
Vector ê²€ìƒ‰ x3-5                    ~150-250ms (ê¸°ì¡´ 50ms x3-5)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì¶”ê°€ ì‹œê°„: +100-200ms
ì´ ì‘ë‹µ ì‹œê°„: 2.3-5.4ì´ˆ
```

**íš¨ê³¼**:
- ë¦¬ì½œ +15-20%
- ì‘ë‹µ ì‹œê°„ +5-10% (ë¯¸ë¯¸)

**ê²°ë¡ **: âœ… **ì„±ëŠ¥ ì˜í–¥ ìµœì†Œ, íš¨ê³¼ ì¢‹ìŒ**

---

#### 3. **ì²­í‚¹ ì„¤ì • ìµœì í™” (512 tokens, 100 overlap)** - âœ… ì¶”ì²œ
**ì„±ëŠ¥ ì˜í–¥**:
```
ì²­í¬ ìˆ˜ ì¦ê°€: 500 tokens â†’ 512 tokens (2% ì¦ê°€)
ì˜¤ë²„ë© ì¦ê°€: 50 â†’ 100 (ì²­í¬ ìˆ˜ +10-15%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë©”ëª¨ë¦¬: +10-15% (Vector ì €ì¥ ê³µê°„)
ê²€ìƒ‰ ì‹œê°„: +0-5ms (ê±°ì˜ ë¬´ì‹œ ê°€ëŠ¥)
```

**íš¨ê³¼**:
- ë¦¬ì½œ +5-10%
- ì„±ëŠ¥ ì˜í–¥ ê±°ì˜ ì—†ìŒ

**ê²°ë¡ **: âœ… **ë¬´ë£Œ ì ì‹¬, ì¦‰ì‹œ ì ìš©**

---

## ğŸ¯ ì„±ëŠ¥ ìš°ì„  ê°œì„  ê³„íš (ìˆ˜ì •ì•ˆ)

### **Phase A: ê³ íš¨ìœ¨ ê°œì„  (3-4ì¼)** âœ… ê¶Œì¥

| ì‘ì—… | ì •í™•ë„ | ë¦¬ì½œ | ì‘ë‹µì‹œê°„ | ë‚œì´ë„ | ì‹œê°„ |
|------|--------|------|---------|--------|------|
| **A-3**: ì²­í‚¹ ìµœì í™” | +5% | +5-10% | +0ms | â­ | 1ì‹œê°„ |
| **A-2**: ë™ì˜ì–´ ì‚¬ì „ | +5% | +15-20% | +100-200ms | â­ | 1-2ì¼ |
| **A-1**: Ollama Reranking | +50-100% | +10% | +300-600ms | â­â­ | 2-3ì¼ |

**ì´ íš¨ê³¼**:
- **ì •í™•ë„**: +60-110%
- **ë¦¬ì½œ**: +30-40%
- **ì‘ë‹µ ì‹œê°„**: 2.2s â†’ 2.6-5.6s (+15-20%)

**ê²°ë¡ **: âœ… **ì„±ëŠ¥ ì˜í–¥ ìµœì†Œ, íš¨ê³¼ ìµœëŒ€**

---

### âŒ **ë³´ë¥˜/ì œì™¸í•  ê¸°ëŠ¥**

#### 1. **ì‹œë§¨í‹± ì²­í‚¹** - ë³´ë¥˜
**ì´ìœ **:
- ë¬¸ì„œ ì¶”ê°€ ì‹œ 30-60ì´ˆ (ì‹¤ì‹œê°„ ë¶ˆê°€)
- ë°°ì¹˜ ì¸ë±ì‹± ì „ìš© (ì•¼ê°„ ì²˜ë¦¬)
- íš¨ê³¼ ëŒ€ë¹„ ë¹„ìš© ê³¼ë‹¤

**ëŒ€ì•ˆ**:
- í˜„ì¬ ë¬¸ì¥ ê²½ê³„ ì²­í‚¹ ìœ ì§€
- ì²­í‚¹ ì„¤ì • ìµœì í™”ë¡œ ì¶©ë¶„ (512 tokens, 100 overlap)

---

#### 2. **LLM Query Rewriting** - ì œì™¸
**ì´ìœ **:
- ì‘ë‹µ ì‹œê°„ +2ì´ˆ (ì‚¬ìš©ì ê²½í—˜ ì €í•˜)
- ì •ì  ë™ì˜ì–´ ì‚¬ì „ìœ¼ë¡œ ì¶©ë¶„
- íš¨ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ ë¹„ìš© 10ë°°

**ëŒ€ì•ˆ**:
- í†µê³„ ìš©ì–´ ë™ì˜ì–´ ì‚¬ì „ (100ê°œ ìš©ì–´)
- ë©”ëª¨ë¦¬ ë‚´ HashMap ê²€ìƒ‰ (~1-2ms)

---

#### 3. **Hybrid Search (BM25)** - ë³´ë¥˜
**ì´ìœ **:
- ì¶”ê°€ ì‹œê°„ +50-100ms
- ë©”ëª¨ë¦¬ ì‚¬ìš© +50MB
- íš¨ê³¼ ëŒ€ë¹„ ë³µì¡ë„ ë†’ìŒ

**ëŒ€ì•ˆ**:
- Query Expansion (ë™ì˜ì–´)ë¡œ í‚¤ì›Œë“œ ì»¤ë²„
- Rerankingìœ¼ë¡œ ì •í™•ë„ ë³´ì™„

---

## ğŸ“Š ìµœì¢… ì„±ëŠ¥ ë¹„êµ

### Before (í˜„ì¬ ì‹œìŠ¤í…œ)
```
ì‘ë‹µ ì‹œê°„: 2.2-5.2ì´ˆ
ì •í™•ë„: 70% (ê°€ì •)
ë¦¬ì½œ: 60% (ê°€ì •)
```

### After (Phase A ì™„ë£Œ)
```
ì‘ë‹µ ì‹œê°„: 2.6-5.6ì´ˆ (+15-20%)
ì •í™•ë„: 112-147% (70% â†’ 148-173) âœ…
ë¦¬ì½œ: 78-84% (+30-40%) âœ…
```

**Trade-off ë¶„ì„**:
- ì‘ë‹µ ì‹œê°„ +0.4-0.4ì´ˆ (ì—¬ì „íˆ <6ì´ˆ, í—ˆìš© ë²”ìœ„)
- ì •í™•ë„ 2ë°° í–¥ìƒ â­â­â­
- ë¦¬ì½œ 30-40% í–¥ìƒ â­â­â­

---

## ğŸš€ ìµœì¢… ê¶Œì¥ ê³„íš

### **ì¦‰ì‹œ ì ìš© (ì„±ëŠ¥ ì˜í–¥ ê±°ì˜ ì—†ìŒ)**

#### 1. ì²­í‚¹ ìµœì í™” (1ì‹œê°„) âš¡
```typescript
// lib/rag/utils/chunking.ts
const DEFAULT_OPTIONS: ChunkOptions = {
  maxTokens: 512,      // 500 â†’ 512 (+2%)
  overlapTokens: 100,  // 50 â†’ 100 (+100%)
  preserveBoundaries: true
}
```

**íš¨ê³¼**: ë¦¬ì½œ +5-10%, ì„±ëŠ¥ ì˜í–¥ 0ms

---

#### 2. ë™ì˜ì–´ ì‚¬ì „ (1-2ì¼) âš¡
```typescript
// lib/rag/utils/query-expansion.ts
const STATS_SYNONYMS: Record<string, string[]> = {
  // ê¸°ë³¸ í†µê³„ ìš©ì–´
  "í‰ê· ": ["mean", "average", "Î¼", "arithmetic mean"],
  "í‘œì¤€í¸ì°¨": ["standard deviation", "SD", "Ïƒ", "stdev"],
  "ì¤‘ì•™ê°’": ["median", "ì¤‘ìœ„ìˆ˜"],

  // ê²€ì • ë°©ë²•
  "t-test": ["tê²€ì •", "student t-test", "independent t-test", "t test"],
  "ANOVA": ["ë¶„ì‚°ë¶„ì„", "analysis of variance", "anova"],
  "chi-square": ["ì¹´ì´ì œê³±", "Ï‡Â²", "chi squared", "chi square"],

  // ìƒê´€/íšŒê·€
  "ìƒê´€ê´€ê³„": ["correlation", "ìƒê´€", "r", "Pearson", "Spearman"],
  "íšŒê·€": ["regression", "íšŒê·€ë¶„ì„"],

  // ë¹„ëª¨ìˆ˜ ê²€ì •
  "Mann-Whitney": ["ë§Œ-íœ˜íŠ¸ë‹ˆ", "U test", "wilcoxon rank sum"],
  "Wilcoxon": ["ìœŒì½•ìŠ¨", "signed rank"],
  "Kruskal-Wallis": ["í¬ë£¨ìŠ¤ì¹¼-ì™ˆë¦¬ìŠ¤", "H test"],

  // ì •ê·œì„± ê²€ì •
  "Shapiro-Wilk": ["ìƒ¤í”¼ë¡œ-ìœŒí¬", "ì •ê·œì„±"],
  "Kolmogorov-Smirnov": ["ì½œëª¨ê³ ë¡œí”„-ìŠ¤ë¯¸ë¥´ë…¸í”„", "KS test"],

  // Python ë¼ì´ë¸ŒëŸ¬ë¦¬
  "scipy": ["SciPy", "scipy.stats"],
  "statsmodels": ["statsmodels"],
  "pingouin": ["pingouin"],

  // í†µê³„ ê°œë…
  "ìœ ì˜ìˆ˜ì¤€": ["significance level", "alpha", "Î±"],
  "p-value": ["pê°’", "p value", "ìœ ì˜í™•ë¥ "],
  "ê·€ë¬´ê°€ì„¤": ["null hypothesis", "H0"],
  "ëŒ€ë¦½ê°€ì„¤": ["alternative hypothesis", "H1", "Ha"],
  "ì‹ ë¢°êµ¬ê°„": ["confidence interval", "CI"],
  "íš¨ê³¼í¬ê¸°": ["effect size", "Cohen's d", "eta squared"],

  // ë°ì´í„° íŠ¹ì„±
  "ì •ê·œë¶„í¬": ["normal distribution", "Gaussian", "ì •ê·œì„±"],
  "ë“±ë¶„ì‚°": ["homogeneity of variance", "equal variance", "homoscedasticity"],
  "ë…ë¦½ì„±": ["independence", "independent"],
}

export function expandQuery(query: string, maxExpansions = 3): string[] {
  const expanded = new Set<string>([query])

  for (const [keyword, synonyms] of Object.entries(STATS_SYNONYMS)) {
    if (query.toLowerCase().includes(keyword.toLowerCase())) {
      // ì›ë³¸ í‚¤ì›Œë“œë¥¼ ë™ì˜ì–´ë¡œ êµì²´
      synonyms.slice(0, maxExpansions).forEach(synonym => {
        const newQuery = query.replace(
          new RegExp(keyword, 'gi'),
          synonym
        )
        expanded.add(newQuery)
      })
    }
  }

  return Array.from(expanded).slice(0, maxExpansions + 1)
}
```

**íš¨ê³¼**: ë¦¬ì½œ +15-20%, ì‘ë‹µ ì‹œê°„ +100-200ms

---

#### 3. Ollama Reranking (2-3ì¼) âš¡
```typescript
// lib/rag/providers/ollama-provider.ts

async query(context: RAGContext): Promise<RAGResponse> {
  // 1. Vector ê²€ìƒ‰ (Top-20)
  const candidates = await this.vectorSearch(context.query, topK: 20)

  // 2. LLM Reranking
  const reranked = await this.rerank(context.query, candidates)

  // 3. Top-5 ì„ íƒ
  const topDocs = reranked.slice(0, 5)

  // 4. LLM ì‘ë‹µ ìƒì„±
  return this.generateResponse(context, topDocs)
}

private async rerank(
  query: string,
  docs: SearchResult[]
): Promise<SearchResult[]> {
  const prompt = `ì§ˆë¬¸: ${query}

ë‹¤ìŒ ë¬¸ì„œë“¤ì„ ì§ˆë¬¸ê³¼ì˜ ê´€ë ¨ì„± ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì‹œì˜¤.
ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œë¶€í„° ë‚˜ì—´í•˜ë¼.

${docs.map((doc, i) => `[${i+1}] ${doc.content.slice(0, 200)}...`).join('\n\n')}

ë‹µë³€ í˜•ì‹: 1,3,5,2,4,... (ìˆ«ìë§Œ, ì‰¼í‘œë¡œ êµ¬ë¶„)
`

  const response = await fetch(`${this.ollamaEndpoint}/api/generate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: this.inferenceModel,
      prompt,
      stream: false,
      options: { temperature: 0 } // ê²°ì •ë¡ ì  ìˆœìœ„
    })
  })

  const result = await response.json()
  const ranking = result.response
    .split(',')
    .map((n: string) => parseInt(n.trim()) - 1) // 0-based index

  return ranking.map((idx: number) => docs[idx])
}
```

**íš¨ê³¼**: ì •í™•ë„ +50-100%, ì‘ë‹µ ì‹œê°„ +300-600ms

---

## ğŸ¯ ì„±ëŠ¥ ì˜ˆì‚° (Performance Budget)

### ëª©í‘œ
- **ì‘ë‹µ ì‹œê°„**: <6ì´ˆ (ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ê¸°ì¤€)
- **ì´ˆê¸° ê²€ìƒ‰**: <500ms
- **Reranking**: <600ms
- **ì´ ì˜¤ë²„í—¤ë“œ**: <1.2ì´ˆ (ê¸°ì¡´ ëŒ€ë¹„)

### ì‹¤ì¸¡ ì˜ˆìƒ
```
ì²­í‚¹ ìµœì í™”:      +0ms         âœ…
ë™ì˜ì–´ í™•ì¥:      +150ms       âœ…
Vector ê²€ìƒ‰ x3:   +100ms       âœ…
Reranking:        +400ms       âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ ì¶”ê°€:          +650ms       âœ… (ëª©í‘œ ë‹¬ì„±)
```

---

## âœ… ìµœì¢… ê²°ë¡ 

### **ì ìš©í•  ê¸°ëŠ¥ (Phase A)**
1. âœ… ì²­í‚¹ ìµœì í™” (1ì‹œê°„)
2. âœ… ë™ì˜ì–´ ì‚¬ì „ (1-2ì¼)
3. âœ… Ollama Reranking (2-3ì¼)

**ì´ íš¨ê³¼**:
- ì •í™•ë„: +60-110% â­â­â­
- ë¦¬ì½œ: +30-40% â­â­â­
- ì‘ë‹µ ì‹œê°„: +0.6ì´ˆ (15-20% ì¦ê°€, ì—¬ì „íˆ <6ì´ˆ) âœ…

---

### **ì œì™¸í•  ê¸°ëŠ¥ (ê³¼ë„í•¨)**
1. âŒ ì‹œë§¨í‹± ì²­í‚¹ â†’ ë¬¸ì„œ ì¶”ê°€ ì‹œ +30-60ì´ˆ (ì‹¤ì‹œê°„ ë¶ˆê°€)
2. âŒ LLM Query Rewriting â†’ ì‘ë‹µ ì‹œê°„ +2ì´ˆ (UX ì €í•˜)
3. âŒ Hybrid Search (BM25) â†’ ë³µì¡ë„ ë†’ìŒ, íš¨ê³¼ ë¯¸ë¯¸

---

### **ì¥ê¸° ê³ ë ¤ (ì„ íƒ)**
- ğŸ”® ì‹œë§¨í‹± ì²­í‚¹: ì•¼ê°„ ë°°ì¹˜ ì¸ë±ì‹± (ë¬¸ì„œ ì¶”ê°€ ì‹œê°„ ë¬´ê´€)
- ğŸ”® BM25 Hybrid: ë¬¸ì„œ ìˆ˜ 10,000+ ì‹œ ê³ ë ¤

---

**ì„±ëŠ¥ vs ì •í™•ë„ ê· í˜•**: âœ… **ìµœì í™” ì™„ë£Œ**

ì‚¬ìš©ì ê²½í—˜ ì €í•˜ ì—†ì´ ì •í™•ë„ 2ë°° í–¥ìƒ ë‹¬ì„±!
