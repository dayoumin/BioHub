# 대규모 리팩토링 품질 확보를 위한 교훈

## 1. 배경
- 분산된 세션과 자동 포맷터로 인해 파일 상태가 자주 바뀌어 에이전트 편집 도구가 잦은 충돌을 일으켰다.
- 개별 페이지마다 즉흥적으로 수정하면서 공통 로직(예: `startAnalysis` 처리, 단계 전환)을 일관되게 적용하지 못했다.
- 계획 없이 setTimeout 제거, 상태 훅 교체 등 고우선 작업을 병렬로 진행하면서 `completeAnalysis` 누락처럼 동일한 실수가 반복되었다.

## 2. 근본 원인
1. **중앙화된 전략 부재**: 리팩토링 대상 패턴과 기대 동작을 문서화하지 않아 각 파일마다 다른 방식으로 처리했다.
2. **세션 동기화 실패**: VSCode 자동 저장/포맷과 에이전트 편집이 충돌했지만, 에디터를 잠시 중단하거나 포맷터를 비활성화하는 운영 규칙이 없었다.
3. **검증 루틴 미비**: 수정 후 최소한의 smoke 테스트나 `rg` 기반 규칙 검사(`startAnalysis()()` 패턴 탐지 등)를 자동화하지 않았다.
4. **작업 분할 부족**: "한 번에 여러 파일"을 목표로 하면서 점진적으로 학습하고 룰을 강화할 기회를 놓쳤다.

## 3. 예방 전략
### 3.1 리팩토링 작업 착수 전
- **작업 설계 문서 작성**: 패턴별 표준 시그니처, 예상 사이드 이펙트, 완료 체크리스트를 사전 정의한다.
- **환경 통제**: 자동 포맷, 저장, 백그라운드 동기화 기능을 작업 시간 동안 일시 중지하고, 병렬 세션 수를 제한한다.
- **세션 락 규칙**: 동일 파일을 다루는 다른 세션/에이전트 작업을 예약제로 운영하거나 락 파일(`.refactor-lock`)을 사용한다.

### 3.2 실행 중
- **단위 배치**: 1~2개 파일 단위로 변경하고, 각 배치 후 `git status`와 `rg` 검사를 통해 규칙 위반을 확인한다.
- **자동 점검 스크립트**: 예시) `rg "startAnalysis\\(\\)\\(\\)" -g'page.tsx'` + `rg "actions.startAnalysis" -g'page.tsx'`를 사전 정의해 반복 실행.
- **체크리스트 기반 PR**: 각 파일마다 `완료 항목`을 템플릿으로 두고, 누락 시 작업 중단 및 재검토.
- **커뮤니케이션 로깅**: 진행 중인 변경과 발견한 이슈를 `dailywork.md`가 아닌 별도 `refactor-log`에 기록해 히스토리를 유지한다.

### 3.3 완료 단계
- **집중 검증**: 
  - 동작 확인: `npm test -- <관련 테스트>` 또는 최소한 `npm run lint`.
  - 규칙 검증: `rg "isAnalyzing"`, `rg "completeAnalysis"` 등 핵심 메서드 호출 여부를 점검.
- **회고 작성**: 예상과 실제 차이를 기록하고, 다음 배치에 반영한다.

## 4. 체크리스트 샘플
1. [ ] 변경 전 패턴/규칙 문서 최신화 확인
2. [ ] 자동 저장/포맷 비활성화 확인 (VSCode, Prettier 등)
3. [ ] 세션 락 파일 생성 및 공유
4. [ ] 배치당 영향 파일 수 ≤ 2
5. [ ] `startAnalysis` → `completeAnalysis` 경로 수동 검사
6. [ ] 커맨드 템플릿 실행 (`rg`, `npm run lint` 등)
7. [ ] 로그 업데이트 (`lesson`, `refactor-log` 등)

## 5. 향후 개선 제안
- **중앙 훅 강화**: `useStatisticsPage`에 `assertAnalysisFlow` 같은 디버깅 모드 옵션을 추가해 분석 시작/완료 미스매치를 자동 경고.
- **CI 규칙**: PR 단계에서 `rg` 기반 커스텀 린트 스크립트를 실행해 `actions.startAnalysis()` 이후 `completeAnalysis` 누락을 감지.
- **작업 가이드 교육**: 신규 참여자에게 패턴 전환, 상태 관리 규칙, 툴 충돌 방지법을 문서+영상으로 제공.
- **실패 사례 데이터베이스**: 이번 사건처럼 자주 겪는 실수를 `lesson/` 폴더에 계속 축적해, 사전 예방과 온보딩 자료로 활용.

---

이번 경험의 핵심 교훈은 **"대규모 리팩토링은 계획과 도구, 운영 규칙 없이는 쉽게 파국으로 흐른다"**는 점이다. 다음 작업부터는 작은 단위로 실험하고, 검증 자동화를 통해 같은 실수를 반복하지 않도록 한다.
